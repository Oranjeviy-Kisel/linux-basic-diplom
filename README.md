## Проектная работа

# Разработка автоматизации восстановления работы web-сервиса с балансировкой Round Robin и централизованного мониторинга с помощью bash-скриптов.

## Описание проекта.

Проект представляет собой план применения автоматизированного восстановления с нуля ("голых" VM) c помощью bash-скриптов и конфигов после
предполагаемого критического обрушения настроенной ранее инфраструктуры.

Инфраструктура состоит из запущенных через Virtual Box 7 виртуальных машин на базе Ubuntu 24 server,
организованных в сеть 10.100.10.0/28 (с доступом в интернет через роутер).

На каждой VM запущен сервис

- 01-fe (фронт-энд веб-сервер NGINX с балансировкой нагрузки на 2 бэк-энд веб-сервера Apache)
- 02-be (бэк-энд веб-сервер Apache, реальный хост сайта)
- 03-be (бэк-энд веб-сервер Apache, реальный хост сайта)
- 04-sql-source (сервер СУБД MySql с базой данных для сайта)
- 05-sql-replica (реплика сервера СУБД MySql)
- 06-monitor (система мониторинга на основе Prometheus + Grafana-визуализация)
- 07-elk (система логирование через стек ELK - Elasticsearch + Logstash + Kibana-визуализация)

# Предварительная подготовка.

Каждая из виртуальных машин клонируется из VM-заготовки, на VM-заготовке настроен:

- root доступ с помощью пары ssh-ключей
- применен через netplan конфиг 60-static.yml

Необходимо для каждой VM изменить netplan конфиг 60-static.yml на соответствующие статические адреса:

- 01-fe `10.100.10.5/28`
- 02-be `10.100.10.6/28`
- 03-be `10.100.10.7/28`
- 04-sql-source `10.100.10.8/28`
- 05-sql-replica `10.100.10.9/28`
- 06-monitor `10.100.10.10/28`
- 07-elk `10.100.10.11/28`

Необходимо для каждой VM изменить имя хоста на соответствующее для корректной отработки скриптов настройки командой

```bash
hostnamectl set-hostname [имя_хоста]
```

(опционально изменить юзера, после изменить home-folder)

```
sudo usermod -l newUsername oldUsername
sudo groupmod -n newUsername oldUsername
sudo usermod -d /home/newHomeDir -m newUsername
```

Проверить root-доступ через ssh на настроенные ранее статические ip, пример

```
ssh root@10.100.10.5
```

В репозитории на Гитхабе не храним рабочие дистрибы, поэтому нееобходимо скопировать дистрибы .dpkg 
(лежат в некотором локальном хранилище, напр. флешке или локальной сетевой папке...) в папки виртуалок:

- 01-fe дистриб filebeat_8.17.1_amd64.deb 
- 06-monitor дистриб grafana_11.2.2_amd64-224190-b9e9cd.deb
- 07-elk дистрибы elasticsearch_8.17.1_amd64.deb, kibana_8.17.1_amd64.deb, logstash_8.17.1_amd64.deb


### Описание 01-fe

Поднят web-сервер NginX.
Настроен в автозагрузку как front-end-server с балансировкой нагрузки к двум back-end веб-серверам `02-be` и `03-be`.
Установлен prometheus-node-exporter для экспорта метрик на сервер мониторинга `06-monitor`.

### Описание 02-fe

Поднят web-сервер Apache, который рендерит html-статику + динамическую часть с данными через php с подключением по запросу к MySQL БД на 04_sql_source.

### Описание 03-fe

Поднят web-сервер Apache, который рендерит свою html-статику.

### Описание 04-sql-source

Поднят сервер базы данных MySQL, настраивается как SOURCE, для корректного управления настраиваются пользователи root и repl для возможности репликации БД.

### Описание 05-sql-replica

Поднят сервер базы данных MySQL, настраивается как REPLICA базы с 04-sql-source. Настроен backup БД скриптом, выполнение добавлено в расписание Cron.

### Описание 06-monitor

Поднят сервер мониторинга Prometheus, установлено web-графическое real-time отображение с дашбордами на основе Grafana 

### Описание 06-elk



# Порядок настройки

Зайти по ssh под root`ом на каждую VM, скачать папку проекта с Гита в дефолтное расположение.
Папка проекта содержит

- текущее описание Readme.md
- основной скрипт `main.sh`
- подпапки, именованные в соответствии с именами хостов: `01-fe` ...etc

Каждая соответствующая подпапка содержит скрипт настройки и необходимые конфиги/файлы, при необходимости дистрибутивы пакетов (в случае недоступности репозиториев).

Дла настройки необходимо запустить от рута /*имя*папки*с*гита/main.sh
Скрипт `main.sh` проверит имя хоста, наличие соответствующей подпапки с таким же именем и запустит из подпапки соответствующий bash-скрипт уже непоредственной настройки.

Дождаться завершения выполнения скрипта, перейти к выполнению на следующую виртуальную машину.

По окончании автоматической настройки перейти к ручной настройке мониторинга и логирования в соответствующие web-интерфейсы:

- http://10.100.10.10:9090 Prometheus
- http://10.100.10.10:3000 Grafana
- http://10.100.10.11:5601 Kibana

Настройки Kibana: management -> stack management -> index management
установить источник поступления weblog-гов с сервера 10.100.10.5 (nginx)


